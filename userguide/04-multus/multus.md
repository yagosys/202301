- ## install multus

*follow https://github.com/k8snetworkplumbingwg/multus-cni to install multus*

here is the quick one 

```
sudo crictl pull ghcr.io/k8snetworkplumbingwg/multus-cni:stable
git clone https://github.com/intel/multus-cni.git
cat /home/ubuntu/multus-cni/deployments/multus-daemonset.yml | kubectl --kubeconfig /home/ubuntu/.kube/config apply -f -

```
- ## multus config file 
by default, the multus CNI will use autogenerated config which just take the first cni configuration found in /etc/cni/net.d/

if you do not want this behavior, you can use the default 70-multus.conf with below command.
```
sudo sed -i 's/multus-conf-file=auto/multus-conf-file=\/tmp\/multus-conf\/70-multus.conf/g' /home/ubuntu/multus-cni/deployments/multus-daemonset.yml
cat /home/ubuntu/multus-cni/deployments/multus-daemonset.yml | kubectl --kubeconfig /home/ubuntu/.kube/config apply -f -

```
the multus ds will create 70-multus.conf with below content under /etc/cni/net.d directory.
if you want make 70-muulus.conf become the first cni that CRIO will use, rename it to  the alphabetically first name ,for example  00-multus.conf  
if your k8s use flannel as default cni before install multus, you also need change cni-conf.json to make it use your default cni.
```
  cni-conf.json: |
    {
      "name": "multus-cni-network",
      "type": "multus",
      "capabilities": {
        "portMappings": true
      },
      "delegates": [
        {
          "cniVersion": "0.3.1",
          "name": "default-cni-network",
          "plugins": [
            {
              "type": "flannel",
              "name": "flannel.1",
                "delegate": {
                  "isDefaultGateway": true,
                  "hairpinMode": true
                }
              },
              {
                "type": "portmap",
                "capabilities": {
                  "portMappings": true
                }
              }
          ]
        }
      ],
      "kubeconfig": "/etc/cni/net.d/multus.d/multus.kubeconfig"
    }
```


```
- troubleshooting multus cni related issue

check the status of multus 
```
kubectl describe ds kube-multus-ds -n kube-system
```
restart the multus ds
```
kubectl rollout restart ds/kube-multus-ds -n kube-system
```
chech the log 
```
ubuntu@ip-10-0-1-100:~/multus-cni/deployments$ kubectl logs ds/kube-multus-ds -n kube-system
Found 3 pods, using pod/kube-multus-ds-qkppk
Defaulted container "kube-multus" out of: kube-multus, install-multus-binary (init)
2023-02-27T23:21:16+00:00 Entering sleep (success)...
```

cni is managed by crio in latest version of k8s, so everytime you change anything under /etc/cni/net.d/. crio will detect it and handle it accordingly. you can use journalctl to check it

```
ubuntu@ip-10-0-1-100:~/multus-cni/deployments$ journalctl -f -u crio
Feb 28 01:59:53 ip-10-0-1-100 crio[482]: time="2023-02-28 01:59:53.124066410Z" level=info msg="Found CNI network multus-cni-network (type=multus) at /etc/cni/net.d/00-multus.conf"
Feb 28 01:59:53 ip-10-0-1-100 crio[482]: time="2023-02-28 01:59:53.140865008Z" level=info msg="Found CNI network cbr0 (type=flannel) at /etc/cni/net.d/10-flannel.conflist"
Feb 28 01:59:53 ip-10-0-1-100 crio[482]: time="2023-02-28 01:59:53.142941151Z" level=info msg="Found CNI network 200-loopback.conf (type=loopback) at /etc/cni/net.d/200-loopback.conf"
Feb 28 01:59:53 ip-10-0-1-100 crio[482]: time="2023-02-28 01:59:53.162083514Z" level=info msg="Found CNI network multus-cni-network (type=multus) at /etc/cni/net.d/70-multus.conf"
Feb 28 01:59:53 ip-10-0-1-100 crio[482]: time="2023-02-28 01:59:53.162124954Z" level=info msg="Ignored CNI network multus-cni-network (type=multus) at /etc/cni/net.d/70-multus.conf because already exists"
Feb 28 01:59:53 ip-10-0-1-100 crio[482]: time="2023-02-28 01:59:53.178071342Z" level=info msg="Found CNI network podman (type=bridge) at /etc/cni/net.d/87-podman.conflist"
Feb 28 01:59:53 ip-10-0-1-100 crio[482]: time="2023-02-28 01:59:53.178106955Z" level=info msg="Updated default CNI network name to multus-cni-network"
Feb 28 01:59:53 ip-10-0-1-100 crio[482]: time="2023-02-28 01:59:53.178127642Z" level=info msg="CNI monitoring event CHMOD         \"/etc/cni/net.d/70-multus.conf\""
Feb 28 01:59:53 ip-10-0-1-100 crio[482]: time="2023-02-28 01:59:53.178147129Z" level=info msg="CNI monitoring event REMOVE        \"/etc/cni/net.d/70-multus.conf~\""
Feb 28 01:59:53 ip-10-0-1-100 crio[482]: time="2023-02-28 01:59:53.178159185Z" level=info msg="CNI monitoring event REMOVE        \"/etc/cni/net.d/.70-multus.conf.swp\""
```

- use multus crd to create net-attach-def 

create a yaml file that include the description of the network.  here is an example

```
ubuntu@ip-10-0-1-100:~/202301/north-test/2023220/flannel$ cat net_bridge_secondary_network_full.yaml
apiVersion: k8s.cni.cncf.io/v1
kind: NetworkAttachmentDefinition
metadata:
  name: cfosdefaultcni5
spec:
  config: |-
    {
      "cniVersion": "0.3.1",
      "name": "cfosdefaultcni5",
      "type": "bridge",
      "bridge": "cni5",
      "isGateway": true,
      "ipMasq": false,
      "hairpinMode": true,
      "ipam": {
          "type": "host-local",
          "routes": [
              { "dst": "10.96.0.0/12","gw": "10.1.128.1" },
              { "dst": "10.0.0.2/32", "gw": "10.1.128.1" }
          ],
          "ranges": [
              [{ "subnet": "10.1.128.0/24" }]
          ]
      }
    }
```

the content under spec.config is the cni json formatted configuration for cni.  the json config is different per different cni. for above example, the bridge CNI will parse the config, it will create  a bridge interfance with name "cni5" on the host, and also assigned ip 10.1.128.1 to this interface, the "host-local" ipam will assign ip from configured ranges and also config route entry for the target POD. 

-  create a NetworkAttachmentDefinition yaml file with an empty json config.  
this leave individule node to create json config. the cni json config on each node must have same as the the one defined in the NetworkAttachmentDefinition yaml file. also the cni json config has to be placed in the directory that specifiy in the mulutus config file. by default it is /etc/cni/multus/net.d/
the way allow you more flexibility to use cni per node. 

for example. 

here is a macvlan cni json config 
```
ubuntu@ip-10-0-2-200:/etc/cni/multus/net.d$ cat macvlan.conf
{
  "cniVersion": "0.3.1",
  "type": "macvlan",
  "name": "macvlan-conf",
  "master": "eth0",
  "mode": "bridge",
  "ipam": {
      "type": "host-local",
      "ranges": [
          [ {
               "subnet": "192.168.1.0/24",
               "rangeStart": "192.168.1.50",
               "rangeEnd": "192.168.1.100"
          } ]
      ]
  }
}

then create a NetworkAttachmentDefinition yaml to reference to macvlan.conf under /etc/cni/multus/net.d on the node.
the metadata name must use the one same as the one in the macvlan.conf. 

```
apiVersion: "k8s.cni.cncf.io/v1"
kind: NetworkAttachmentDefinition
metadata:
  name: macvlan-conf
```


how to let POD to use NtwokAttachment created by NetworkAttachmentDefinition.


a POD can use annotation to specify the network to use for a POD.

for default network. the synax for annotate is 

```
      annotations:
        v1.multus-cni.io/default-network: default/cfosdefaultcni5
```
the default is the namespace name. 
the cfosdefaultcni5 is the NetworkAttachment name created by NetworkAttachmentDefinition. by default, the default-network is looking NetworkAttachment in kube-system namespace.
so if cfosdefaultcni5 is created in default namespace, add "default/" ahead of cfosdefaultcni5

with this annotation, pod will get default ip from network cfosdefaultcni5.



for additional network, the syntax for annotate is 

```
      annotations:
        k8s.v1.cni.cncf.io/networks: '[ { "name": "br-10-1-128" , "ips": [ "10.1.128.2/32" ],"mac": "CA:FE:C0:FF:EE:02" } ]'

```
 the value of key k8s.v1.cni.cncf.io/networks is a map, so you can attach a POD to multiple network. POD then will get multiple IPs. you may also assign fixed IP address or mac address to POD.

``` 
      k8s.v1.cni.cncf.io/networks: '[ { "name": "br-10-1-128"  , "default-route": ["10.1.128.2"] } ]'

```
above example attach POD to network with name br-10-1-128, and also add a default route with gateway =10.1.128.2 for that POD.


